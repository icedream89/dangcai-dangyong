<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangcai.business.mapper.CourseMapper">

    <!-- 分页查询课堂列表 -->
    <select id="selectCourseList" resultType="com.dangcai.business.vo.CourseVO">
        SELECT
            id,
            course_title,
            course_type,
            CASE course_type
                WHEN 'video' THEN '视频'
                WHEN 'document' THEN '文档'
                WHEN 'article' THEN '图文'
                ELSE '未知'
            END AS course_type_name,
            cover_image,
            category,
            summary,
            content,
            attachments,
            duration,
            FLOOR(duration / 60) AS duration_display,
            view_count,
            is_recommended,
            sort_order,
            status,
            CASE status
                WHEN 0 THEN '下架'
                WHEN 1 THEN '发布'
                ELSE '未知'
            END AS status_name,
            publish_time,
            create_time,
            update_time
        FROM biz_course
        <where>
            del_flag = 0
            <if test="courseTitle != null and courseTitle != ''">
                AND course_title LIKE CONCAT('%', #{courseTitle}, '%')
            </if>
            <if test="courseType != null and courseType != ''">
                AND course_type = #{courseType}
            </if>
            <if test="category != null and category != ''">
                AND category = #{category}
            </if>
            <if test="isRecommended != null">
                AND is_recommended = #{isRecommended}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY is_recommended DESC, sort_order ASC, create_time DESC
    </select>

    <!-- 根据ID查询课堂VO -->
    <select id="selectCourseVOById" resultType="com.dangcai.business.vo.CourseVO">
        SELECT
            id,
            course_title,
            course_type,
            CASE course_type
                WHEN 'video' THEN '视频'
                WHEN 'document' THEN '文档'
                WHEN 'article' THEN '图文'
                ELSE '未知'
            END AS course_type_name,
            cover_image,
            category,
            summary,
            content,
            attachments,
            duration,
            FLOOR(duration / 60) AS duration_display,
            view_count,
            is_recommended,
            sort_order,
            status,
            CASE status
                WHEN 0 THEN '下架'
                WHEN 1 THEN '发布'
                ELSE '未知'
            END AS status_name,
            publish_time,
            create_time,
            update_time
        FROM biz_course
        WHERE id = #{id} AND del_flag = 0
    </select>

    <!-- 增加浏览次数 -->
    <update id="increaseViewCount">
        UPDATE biz_course
        SET view_count = view_count + 1
        WHERE id = #{id} AND del_flag = 0
    </update>

</mapper>
